<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResoChat | Dashboard</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-sidebar: #2b2d31;
            --bg-main: #313338;
            --bg-servers: #1e1f22;
            --bg-user: #232428;
            --bg-input: #383a40;
            --text-muted: #b5bac1;
            --blurple: #5865f2;
            --success: #23a559;
            --danger: #fa777a;
            --transition: all 0.2s ease;
        }

        body, html {
            margin: 0; padding: 0;
            height: 100vh; width: 100vw;
            font-family: 'Helvetica Neue', Arial, sans-serif;
            overflow: hidden;
            background-color: var(--bg-main);
            color: white;
        }

        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .animate-fade { animation: fadeIn 0.3s ease forwards; }
        .animate-slide { animation: slideIn 0.2s ease forwards; }

        /* --- Layout --- */
        #loading-screen {
            position: fixed; inset: 0; background: var(--bg-main);
            display: flex; justify-content: center; align-items: center; z-index: 9999;
        }

        .app-container { display: flex; height: 100vh; width: 100vw; visibility: hidden; }

        .server-rail { width: 72px; background: var(--bg-servers); display: flex; flex-direction: column; align-items: center; padding-top: 12px; }
        .sidebar { width: 240px; background: var(--bg-sidebar); display: flex; flex-direction: column; }
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-main); position: relative; }

        /* --- Components --- */
        .dm-list { flex: 1; padding: 8px; overflow-y: auto; }
        .dm-item { padding: 8px; border-radius: 4px; display: flex; align-items: center; gap: 12px; cursor: pointer; color: var(--text-muted); transition: var(--transition); }
        .dm-item:hover, .dm-item.active { background: #35373c; color: white; }

        .avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; color: white; flex-shrink: 0; }

        .top-nav { height: 48px; padding: 0 16px; border-bottom: 1px solid rgba(0,0,0,0.2); display: flex; align-items: center; }

        /* --- Chat --- */
        .chat-area { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .messages-container { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
        .message { display: flex; gap: 16px; padding: 4px 0; }
        .msg-user { font-weight: 600; font-size: 15px; }
        .msg-text { color: #dbdee1; font-size: 15px; margin-top: 2px; }

        .chat-input-wrapper { padding: 0 16px 24px 16px; }
        .chat-input-box { background: var(--bg-input); border-radius: 8px; padding: 10px 16px; display: flex; align-items: center; }
        .chat-input-box input { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 15px; }

        /* --- Status Light --- */
        #status-indicator {
            position: fixed; bottom: 10px; left: 10px; width: 8px; height: 8px;
            border-radius: 50%; background: var(--danger); z-index: 1000;
        }

        .nav-item { margin: 0 8px; cursor: pointer; color: var(--text-muted); font-size: 14px; }
        .nav-item.active { color: white; }
    </style>
</head>
<body>

    <div id="status-indicator" title="Connection Status"></div>

    <div id="loading-screen">
        <h3>Loading ResoChat...</h3>
    </div>

    <div class="app-container" id="app-ui">
        <div class="server-rail">
            <div style="width:48px; height:48px; background:var(--blurple); border-radius:16px; display:flex; align-items:center; justify-content:center;">
                <i data-lucide="message-circle"></i>
            </div>
        </div>

        <div class="sidebar">
            <div style="padding:12px; font-weight:bold; border-bottom:1px solid rgba(0,0,0,0.2);">Direct Messages</div>
            <div class="dm-list">
                <div class="dm-item" onclick="showFriendsView('all')"><i data-lucide="users"></i> Friends</div>
                <div style="text-transform: uppercase; font-size: 11px; font-weight: bold; color: var(--text-muted); margin: 15px 8px 5px;">Direct Messages</div>
                <div id="active-dms"></div>
            </div>
            
            <div style="height:52px; background:var(--bg-user); padding:0 8px; display:flex; align-items:center; gap:8px;">
                <div id="user-avatar" class="avatar">?</div>
                <div style="flex:1; overflow:hidden; text-overflow:ellipsis; font-size:13px; font-weight:600;" id="display-username">User</div>
                <i data-lucide="log-out" onclick="logout()" style="width:18px; cursor:pointer; color:var(--text-muted);"></i>
            </div>
        </div>

        <div class="main-content">
            <div class="top-nav" id="top-nav"></div>
            <div id="display-area" style="flex:1; overflow:hidden;"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, setDoc, collection, query, where, onSnapshot, deleteDoc, addDoc, orderBy, serverTimestamp, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // CLEAN CONFIG: No Analytics/Storage to prevent 403 errors
        const firebaseConfig = {
            apiKey: "AIzaSyAQTMaN3vqB2SULVQLqy40VaMB413x7LGg",
            authDomain: "reso-chat.firebaseapp.com",
            projectId: "reso-chat",
            messagingSenderId: "693778277273",
            appId: "1:693778277273:web:3419c420aa2018929aa908"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUser = null;
        let unsubMessages = null;

        // AUTH TRACKER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userSnap = await getDoc(doc(db, "users", user.uid));
                if (userSnap.exists()) {
                    currentUser = { ...userSnap.data(), uid: user.uid };
                    document.getElementById('status-indicator').style.background = 'var(--success)';
                    initApp();
                } else { window.location.href = "index.html"; }
            } else { window.location.href = "index.html"; }
        });

        function initApp() {
            document.getElementById('display-username').innerText = currentUser.username;
            document.getElementById('user-avatar').innerText = currentUser.username[0];
            document.getElementById('user-avatar').style.background = '#5865f2';
            
            listenForFriends();
            showFriendsView('all');
            lucide.createIcons();
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('app-ui').style.visibility = 'visible';
        }

        // FRIENDS LIST LOGIC
        function listenForFriends() {
            onSnapshot(collection(db, "users", currentUser.uid, "friends"), (snap) => {
                const list = document.getElementById('active-dms');
                list.innerHTML = "";
                snap.forEach(d => {
                    const friend = d.data();
                    const item = document.createElement('div');
                    item.className = 'dm-item animate-slide';
                    item.onclick = () => openChat(d.id, friend.username);
                    item.innerHTML = `<div class="avatar" style="width:24px; height:24px; font-size:10px; background:#4e5058">${friend.username[0]}</div> <span>${friend.username}</span>`;
                    list.appendChild(item);
                });
            });
        }

        window.showFriendsView = (view) => {
            if(unsubMessages) unsubMessages();
            const topNav = document.getElementById('top-nav');
            topNav.innerHTML = `<i data-lucide="users"></i> <span style="margin-left:10px; font-weight:bold;">Friends</span>`;
            
            const area = document.getElementById('display-area');
            area.innerHTML = `<div style="padding:20px;"><button onclick="showAddFriendView()" style="background:var(--success); color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Add Friend</button></div>`;
            lucide.createIcons();
        };

        window.showAddFriendView = () => {
            const area = document.getElementById('display-area');
            area.innerHTML = `
                <div style="padding:20px;" class="animate-fade">
                    <h3>Add Friend</h3>
                    <div class="chat-input-box" style="max-width:400px;">
                        <input type="text" id="target-username" placeholder="Enter username">
                        <button onclick="sendFriendRequest()" style="background:var(--blurple); color:white; border:none; padding:5px 10px; border-radius:4px;">Add</button>
                    </div>
                    <p id="status-msg" style="margin-top:10px;"></p>
                </div>`;
        };

        window.sendFriendRequest = async () => {
            const name = document.getElementById('target-username').value.toLowerCase().trim();
            const msg = document.getElementById('status-msg');
            if(!name) return;

            const snap = await getDoc(doc(db, "usernames", name));
            if(snap.exists()) {
                await addDoc(collection(db, "friend_requests"), {
                    from: currentUser.uid, fromName: currentUser.username,
                    to: snap.data().uid, status: 'pending'
                });
                msg.innerText = "Request sent!";
                msg.style.color = "var(--success)";
            } else {
                msg.innerText = "User not found.";
                msg.style.color = "var(--danger)";
            }
        };

        // --- CHAT LOGIC ---
        window.openChat = (friendId, friendName) => {
            const topNav = document.getElementById('top-nav');
            topNav.innerHTML = `<div style="font-weight:bold;">@ ${friendName}</div>`;
            
            const area = document.getElementById('display-area');
            area.className = "chat-area";
            area.innerHTML = `
                <div class="messages-container" id="messages-list"></div>
                <div class="chat-input-wrapper">
                    <div class="chat-input-box">
                        <input type="text" id="msg-input" placeholder="Message @${friendName}">
                    </div>
                </div>`;

            const input = document.getElementById('msg-input');
            input.addEventListener('keypress', (e) => {
                if(e.key === 'Enter' && input.value.trim()) {
                    sendMessage(friendId, input.value.trim());
                    input.value = '';
                }
            });

            const chatId = [currentUser.uid, friendId].sort().join('_');
            const q = query(collection(db, "chats", chatId, "messages"), orderBy("timestamp", "asc"), limit(50));
            
            if(unsubMessages) unsubMessages();
            unsubMessages = onSnapshot(q, (snap) => {
                const list = document.getElementById('messages-list');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    list.innerHTML += `
                        <div class="message animate-fade">
                            <div class="avatar" style="background:#5865f2">${m.senderName[0]}</div>
                            <div><div class="msg-user">${m.senderName}</div><div class="msg-text">${m.text}</div></div>
                        </div>`;
                });
                list.scrollTop = list.scrollHeight;
            });
        };

        async function sendMessage(toId, text) {
            const chatId = [currentUser.uid, toId].sort().join('_');
            try {
                await addDoc(collection(db, "chats", chatId, "messages"), {
                    text: text,
                    senderId: currentUser.uid,
                    senderName: currentUser.username,
                    timestamp: serverTimestamp()
                });
            } catch (e) {
                alert("Failed to send: " + e.message);
            }
        }

        window.logout = () => signOut(auth).then(() => window.location.href = "index.html");
    </script>
</body>
</html>
